<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Научная библиотека — Липецкий филиал РАНХиГС</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#fafafa; }
    header { background:#fff; border-bottom:4px solid #8b0000; padding:15px 20px; }
    header h1 { margin:0; font-size:22px; color:#222; }
    header h2 { margin:5px 0 0; font-size:14px; color:#666; font-weight:normal; }

    .container { max-width:900px; margin:20px auto; padding:0 10px; }
    .search-box { display:flex; gap:10px; margin-bottom:20px; }
    .search-box input { flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:5px; }
    .search-box button { background:#8b0000; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
    .search-box button:hover { background:#a00000; }

    .results { display:flex; flex-direction:column; gap:10px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:15px; }
    .card h3 { margin:0; font-size:16px; color:#222; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .card p { margin:5px 0 0; font-size:13px; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .card small { display:block; margin-top:5px; color:#888; }
    .actions { margin-top:8px; }
    .actions a { margin-right:15px; color:#a00000; text-decoration:none; font-weight:bold; }
    .actions a:hover { text-decoration:underline; }

    /* Модалка */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; align-items:center; justify-content:center; }
    .modal.open { display:flex; }
    .modal-content { background:#fff; max-width:95%; max-height:90%; border-radius:8px; padding:15px; overflow:auto; position:relative; }
    .modal h3 { margin:0 0 10px; font-size:16px; }
    .modal .close { position:absolute; top:10px; right:10px; background:#aaa; border:none; border-radius:5px; padding:5px 10px; color:#fff; cursor:pointer; }
    .modal .close:hover { background:#888; }
    .modal .viewer { margin-top:10px; max-height:70vh; overflow:auto; }
    .modal img { max-width:100%; height:auto; }
    .modal pre { background:#f5f5f5; padding:10px; overflow-x:auto; font-size:13px; }
    .hint { font-size:14px; color:#888; }
  </style>
</head>
<body>
  <header>
    <h1>ПРЕЗИДЕНТСКАЯ АКАДЕМИЯ — НАУЧНАЯ БИБЛИОТЕКА</h1>
    <h2>Липецкий филиал РАНХиГС</h2>
  </header>
  <div class="container">
    <div class="search-box">
      <input id="query" type="text" placeholder="Введите часть имени файла…">
      <button onclick="searchFiles()">Найти</button>
    </div>
    <div class="results" id="results"></div>
  </div>

  <!-- Модалка -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="close" onclick="modal.classList.remove('open')">Закрыть</button>
      <h3 id="mtitle"></h3>
      <div class="actions">
        <a id="mdown" href="#" target="_blank">Скачать файл</a>
        <a id="mopen" href="#" target="_blank">Открыть в новой вкладке</a>
      </div>
      <div class="viewer" id="mview"><div class="hint">Предпросмотр</div></div>
      <div class="hint" id="mstatus"></div>
    </div>
  </div>

  <script>
    const repo = "Ranepalip/-"; // Укажи свой репозиторий
    const branch = "main";
    const token = ""; // Можно вставить токен здесь если нужен приватный репозиторий

    const modal = document.getElementById("modal");
    const mtitle = document.getElementById("mtitle");
    const mdown = document.getElementById("mdown");
    const mopen = document.getElementById("mopen");
    const mview = document.getElementById("mview");
    const mstatus = document.getElementById("mstatus");

    async function searchFiles() {
      const q = document.getElementById("query").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Загрузка…";
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/git/trees/${branch}?recursive=1`, {
          headers: token ? { Authorization: "token " + token } : {}
        });
        const data = await res.json();
        if (!data.tree) throw new Error("Файлы не найдены");
        const files = data.tree.filter(f => f.type === "blob");
        const filtered = q ? files.filter(f => f.path.toLowerCase().includes(q)) : files;
        resultsDiv.innerHTML = "";
        if (!filtered.length) { resultsDiv.textContent = "Ничего не найдено"; return; }
        filtered.forEach(f => {
          const raw = `https://raw.githubusercontent.com/${repo}/${branch}/${encodeURIComponent(f.path)}`;
          const ext = f.path.split(".").pop().toLowerCase();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h3>${f.path.split("/").pop()}</h3>
            <p>${f.path}</p>
            <small>${(f.size/1024).toFixed(2)} KB</small>
            <div class="actions">
              <a href="${raw}" target="_blank">Скачать</a>
              <a href="#" onclick="openPreview('${raw}','${f.path}','${ext}');return false;">Смотреть</a>
            </div>`;
          resultsDiv.appendChild(card);
        });
      } catch(e) {
        resultsDiv.textContent = "Ошибка загрузки: " + e.message;
      }
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function openInNewTab(url) {
      try {
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener';
        document.body.appendChild(a); a.click(); a.remove();
      } catch { window.open(url,'_blank'); }
    }

    function openPreview(rawUrl, displayName, ext) {
      mtitle.textContent = displayName;
      mdown.href = rawUrl;
      mopen.href = rawUrl;
      mstatus.textContent = "";
      mview.innerHTML = "";
      modal.classList.add("open");

      if (ext === "pdf") {
        const viewerBase = "https://mozilla.github.io/pdf.js/web/viewer.html";
        const viewerUrl = viewerBase + "?file=" + encodeURIComponent(rawUrl);
        modal.classList.remove("open"); // сразу в новую вкладку
        openInNewTab(viewerUrl);
        return;
      }

      if (["png","jpg","jpeg","gif","webp"].includes(ext)) {
        mview.innerHTML = `<img src="${rawUrl}" alt="${escapeHtml(displayName)}">`;
        return;
      }

      if (["txt","md","csv","html","htm","log"].includes(ext)) {
        fetch(rawUrl).then(r=>r.text()).then(text=>{
          mview.innerHTML = `<pre>${escapeHtml(text)}</pre>`;
        }).catch(()=> mview.innerHTML="<div class='hint'>Ошибка предпросмотра</div>");
        return;
      }

      mview.innerHTML = "<div class='hint'>Предпросмотр недоступен, скачайте файл</div>";
    }
  </script>
</body>
</html>
