<script>
  const OWNER  = 'Ranepalip';
  const REPO   = '-';
  const BRANCH = 'main';

  // Базовый префикс проекта (например, "/-/" для project pages)
  // Работает и если сайт в корне (будет "/")
  const BASE = (location.pathname.match(/^\/[^/]+\/?/) || ['/'])[0];
  // Пример: BASE === "/-/" -> файл лежит по "/-/Имя.pdf"
  // viewer лежит по "/-/pdfjs/web/viewer.html"

  const filesEl = document.getElementById('files');
  const qEl = document.getElementById('q');
  let allFiles = [];

  function isIOS() {
    const ua = navigator.userAgent;
    const iPadOS = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
    return /iPad|iPhone|iPod/.test(ua) || iPadOS;
  }

  async function reloadFiles() {
    filesEl.innerHTML = '<div class="empty">Загружаю список…</div>';
    try {
      const url = `https://api.github.com/repos/${OWNER}/${encodeURIComponent(REPO)}/contents?ref=${BRANCH}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!res.ok) throw new Error('GitHub API error: ' + res.status);
      const data = await res.json();
      allFiles = data.filter(x => x.type === 'file');
      applyFilter();
    } catch (e) {
      filesEl.innerHTML = `<div class="empty">Не удалось получить список файлов. Ошибка: ${e.message}</div>`;
    }
  }

  function applyFilter() {
    const term = (qEl.value || '').trim().toLowerCase();
    const list = !term ? allFiles : allFiles.filter(it => it.name.toLowerCase().includes(term));
    if (!list.length) { filesEl.innerHTML = '<div class="empty">Ничего не найдено</div>'; return; }
    const frag = document.createDocumentFragment();
    list.forEach(f => frag.appendChild(renderFileRow(f)));
    filesEl.innerHTML = ''; filesEl.appendChild(frag);
  }

  function renderFileRow(file) {
    const name = file.name;
    const ext  = name.split('.').pop().toLowerCase();

    // Полные корректные URL c учётом префикса проекта
    const fileUrl   = BASE + encodeURIComponent(name);
    const viewerUrl = BASE + 'pdfjs/web/viewer.html?file=' + encodeURIComponent(fileUrl);

    const row = document.createElement('div');
    row.className = 'file-card';

    const title = document.createElement('div');
    title.className = 'file-title';
    title.textContent = name;

    const actions = document.createElement('div');
    actions.className = 'actions';

    if (ext === 'pdf') {
      const watch = document.createElement('button');
      watch.className = 'btn';
      watch.textContent = 'Смотреть';
      watch.onclick = () => openPdf(viewerUrl);
      actions.appendChild(watch);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = fileUrl;
      dl.download = name;
      dl.textContent = 'Скачать';
      actions.appendChild(dl);

    } else if (['jpg','jpeg','png','gif','txt','html'].includes(ext)) {
      const watch = document.createElement('button');
      watch.className = 'btn';
      watch.textContent = 'Смотреть';
      watch.onclick = () => openSimple(fileUrl);
      actions.appendChild(watch);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = fileUrl;
      dl.download = name;
      dl.textContent = 'Скачать';
      actions.appendChild(dl);

    } else {
      const hint = document.createElement('span');
      hint.className = 'hint';
      hint.textContent = 'Предпросмотр недоступен';
      actions.appendChild(hint);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = fileUrl;
      dl.download = name;
      dl.textContent = 'Скачать';
      actions.appendChild(dl);
    }

    row.appendChild(title);
    row.appendChild(actions);
    return row;
  }

  function openPdf(viewerUrl) {
    if (isIOS()) { window.open(viewerUrl, '_blank', 'noopener'); return; }
    openInModal(viewerUrl);
  }

  function openSimple(url) {
    if (isIOS()) { window.open(url, '_blank', 'noopener'); return; }
    openInModal(url);
  }

  function openInModal(url) {
    const viewer = document.getElementById('viewer');
    const frame  = document.getElementById('viewerFrame');
    viewer.style.display = 'flex';
    setTimeout(() => frame.src = url, 30);
  }

  function closeViewer() {
    const viewer = document.getElementById('viewer');
    const frame  = document.getElementById('viewerFrame');
    frame.src = 'about:blank';
    viewer.style.display = 'none';
  }

  reloadFiles();
</script>
