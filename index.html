<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ù–∞—É—á–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ ‚Äî –õ–∏–ø–µ—Ü–∫–∏–π —Ñ–∏–ª–∏–∞–ª –†–ê–ù–•–∏–ì–°</title>
<style>
  :root {
    --brand: #900;
    --brand-2: #c00;
    --bg: #f6f6f8;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: #111; }
  header { background: var(--brand); color: #fff; padding: 16px; }
  header .title { font-size: 18px; font-weight: 700; }
  header .sub { font-size: 13px; opacity: .9; }
  .container { padding: 16px; max-width: 1024px; margin: 0 auto; }
  .search-bar {
    display: grid; grid-template-columns: 1fr auto; gap: 10px;
    background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.06);
  }
  .search-bar input {
    width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 15px;
  }
  .search-bar button {
    appearance: none; border: 0; border-radius: 8px; padding: 10px 16px; cursor: pointer;
    background: var(--brand); color: #fff; font-size: 15px;
  }
  .search-bar button:hover { background: var(--brand-2); }
  .files { margin-top: 14px; }
  .file-card {
    background: #fff; border-radius: 10px; padding: 14px;
    margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,.06);
    display: flex; justify-content: space-between; gap: 12px; align-items: center;
  }
  .file-title { font-size: 15px; line-height: 1.35; overflow-wrap: anywhere; }
  .actions { display: flex; gap: 8px; white-space: nowrap; }
  button.btn, .btn {
    appearance: none; border: 0; border-radius: 8px; padding: 8px 14px; cursor: pointer;
    background: var(--brand); color: #fff; text-decoration: none; display: inline-flex; align-items: center; font-size: 14px;
  }
  .btn:hover { background: var(--brand-2); }
  .secondary { background: #444; }
  .secondary:hover { background: #222; }
  .hint { color: #c00; font-size: 13px; margin-right: 8px; }

  .empty { text-align: center; color: #666; padding: 40px 10px; }

  /* viewer modal */
  .viewer {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,.7); z-index: 9999; padding: 10px;
  }
  .viewer-content {
    position: relative; width: 100%; height: 100%;
    max-width: 1400px; max-height: 98vh; background: #fff; border-radius: 10px; overflow: hidden;
  }
  .close-btn {
    position: absolute; top: 8px; right: 8px; z-index: 2;
    background: var(--brand); color: #fff; border: 0; border-radius: 6px; padding: 7px 12px; cursor: pointer;
  }
  .frame {
    width: 100%; height: 100%; border: 0;
    -webkit-overflow-scrolling: touch;
  }

  @media (max-width: 640px) {
    .file-card { flex-direction: column; align-items: stretch; }
    .actions { justify-content: flex-end; }
  }
</style>
</head>
<body>

<header>
  <div class="title">üìö –ù–∞—É—á–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
  <div class="sub">–õ–∏–ø–µ—Ü–∫–∏–π —Ñ–∏–ª–∏–∞–ª –†–ê–ù–•–∏–ì–°</div>
</header>

<div class="container">
  <!-- –ü–æ–∏—Å–∫ -->
  <div class="search-bar">
    <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞‚Ä¶" oninput="applyFilter()" />
    <button onclick="reloadFiles()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ -->
  <div id="files" class="files"></div>
</div>

<!-- –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ -->
<div class="viewer" id="viewer">
  <div class="viewer-content">
    <button class="close-btn" onclick="closeViewer()">–ó–∞–∫—Ä—ã—Ç—å</button>
    <iframe id="viewerFrame" class="frame" allow="fullscreen" allowfullscreen webkitallowfullscreen referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<script>
  const OWNER = 'Ranepalip';
  const REPO  = '-';
  const BRANCH = 'main';

  const filesEl = document.getElementById('files');
  const qEl = document.getElementById('q');

  let allFiles = [];

  // iOS –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
  function isIOS() {
    const ua = navigator.userAgent;
    const iPadOS = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
    return /iPad|iPhone|iPod/.test(ua) || iPadOS;
  }

  async function reloadFiles() {
    filesEl.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫‚Ä¶</div>';
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      const url = `https://api.github.com/repos/${OWNER}/${encodeURIComponent(REPO)}/contents?ref=${BRANCH}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!res.ok) throw new Error('GitHub API error: ' + res.status);
      const data = await res.json();
      // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã
      allFiles = data.filter(x => x.type === 'file');
      applyFilter();
    } catch (e) {
      filesEl.innerHTML = `<div class="empty">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤. –û—à–∏–±–∫–∞: ${e.message}</div>`;
    }
  }

  function applyFilter() {
    const term = (qEl.value || '').trim().toLowerCase();
    const list = !term
      ? allFiles
      : allFiles.filter(it => it.name.toLowerCase().includes(term));

    if (!list.length) {
      filesEl.innerHTML = '<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(file => frag.appendChild(renderFileRow(file)));
    filesEl.innerHTML = '';
    filesEl.appendChild(frag);
  }

  function renderFileRow(file) {
    const name = file.name;
    const ext = name.split('.').pop().toLowerCase();
    const container = document.createElement('div');
    container.className = 'file-card';

    const title = document.createElement('div');
    title.className = 'file-title';
    title.textContent = name;

    const actions = document.createElement('div');
    actions.className = 'actions';

    // –ü–æ–ª–Ω—ã–π –ø—É—Ç—å —Ñ–∞–π–ª–∞ –¥–ª—è viewer (–ª–µ–∂–∏—Ç –≤ –∫–æ—Ä–Ω–µ Pages)
    const encoded = encodeURIComponent(name);
    const viewerUrl = `/pdfjs/web/viewer.html?file=/-/${encoded}`;

    if (ext === 'pdf') {
      const watch = document.createElement('button');
      watch.className = 'btn';
      watch.textContent = '–°–º–æ—Ç—Ä–µ—Ç—å';
      watch.onclick = () => openPdf(viewerUrl);
      actions.appendChild(watch);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = `/-/${encoded}`;
      dl.download = name;
      dl.textContent = '–°–∫–∞—á–∞—Ç—å';
      actions.appendChild(dl);

    } else if (['jpg','jpeg','png','gif','txt','html'].includes(ext)) {
      const watch = document.createElement('button');
      watch.className = 'btn';
      watch.textContent = '–°–º–æ—Ç—Ä–µ—Ç—å';
      watch.onclick = () => openSimple(`/-/${encoded}`);
      actions.appendChild(watch);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = `/-/${encoded}`;
      dl.download = name;
      dl.textContent = '–°–∫–∞—á–∞—Ç—å';
      actions.appendChild(dl);

    } else {
      const hint = document.createElement('span');
      hint.className = 'hint';
      hint.textContent = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      actions.appendChild(hint);

      const dl = document.createElement('a');
      dl.className = 'btn secondary';
      dl.href = `/-/${encoded}`;
      dl.download = name;
      dl.textContent = '–°–∫–∞—á–∞—Ç—å';
      actions.appendChild(dl);
    }

    container.appendChild(title);
    container.appendChild(actions);
    return container;
  }

  function openPdf(viewerUrl) {
    if (isIOS()) {
      // iOS ‚Äî —Ç–æ–ª—å–∫–æ –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞
      window.open(viewerUrl, '_blank', 'noopener');
      return;
    }
    openInModal(viewerUrl);
  }

  function openSimple(url) {
    if (isIOS()) {
      window.open(url, '_blank', 'noopener');
      return;
    }
    openInModal(url);
  }

  function openInModal(url) {
    const viewer = document.getElementById('viewer');
    const frame = document.getElementById('viewerFrame');
    viewer.style.display = 'flex';
    // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–µ—Ä —É–º–µ–Ω—å—à–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å ¬´–±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞¬ª –≤ Safari
    setTimeout(() => frame.src = url, 30);
  }

  function closeViewer() {
    const viewer = document.getElementById('viewer');
    const frame = document.getElementById('viewerFrame');
    frame.src = 'about:blank';
    viewer.style.display = 'none';
  }

  // –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
  reloadFiles();
</script>
</body>
</html>
